<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta name="format-detection" content="telphone=no, email=no"/>
    <title>养生汇系统</title>
    <link rel="stylesheet" href="./css/base.css?v=0.0.1">
    <link rel="stylesheet" href="./css/function.css?v=0.0.1">
    <link rel="stylesheet" href="./css/style.css?v=0.0.1">
</head>
<body>
<div class="menu-container">
    <div class="main">
        <div class="logo">店铺LOGO</div>
        <div class="shop-info"><span id="shopTopName"></span> <a id="exit">退出</a></div>
        <a class="menu" href="#"><img src="img/ico-vip.png"></a>
        <a class="menu" href="shop.html"><img src="img/ico-submit.png"></a>
        <a class="menu" href="order-list.html"><img src="img/ico-order.png"></a>
        <a class="menu" href="order-choose-project.html"><img src="img/ico-shop.png"></a>
    </div>
</div>
<div class="main-container">
    <div class="c-left">
        <dl>
    <dt><i></i>店铺</dt>
    <dd><a href="shop.html">店铺信息</a></dd>
    <dd><a href="shop-edit.html">编辑信息</a></dd>
    <dd><a href="shop-comment.html">店铺评价</a></dd>
</dl>
<dl>
    <dt><i></i>技师</dt>
    <dd><a href="tech-list.html">技师列表</a></dd>
    <dd><a href="tech-add.html" class="add-item">添加技师</a></dd>
</dl>
<dl>
    <dt><i></i>项目</dt>
    <dd><a href="pro-list.html">项目列表</a></dd>
    <dd><a href="pro-add.html" class="add-item">发布项目</a></dd>
</dl>
<dl>
    <dt><i></i>房间</dt>
    <dd><a href="room-list.html">房间列表</a></dd>
    <dd><a href="room-add.html" class="add-item">发布房间</a></dd>
</dl>
    </div>
    <div class="c-right">
        <div class="title">添加技师</div>
        <div class="section">
            <table class="table-default">
                <tr>
                    <td width="100">工号</td>
                    <td><input id="techNo" type="text" class="input-small" name=""></td>
                </tr>
                <tr>
                    <td width="100">昵称</td>
                    <td><input id="techNick" type="text" class="input-small" name=""></td>
                </tr>
                <tr>
                    <td width="100">出生年月</td>
                    <td><input id="datetimepicker" type="text" class="input-small laydate-icon" onclick="laydate({max: laydate.now()})"></td>
                </tr>
                <tr>
                    <td width="100">籍贯</td>
                    <td><select id="techNative" class="input-small"></select></td>
                </tr>
                <tr>
                    <td width="100">性别</td>
                    <td><input type="radio" name="sex" value="1"> 男&nbsp;&nbsp;&nbsp;<input type="radio" name="sex" value="2"> 女</td>
                </tr>
                
            </table>
        </div>
        <div class="section">
            <h1>头像</h1>
            <img src="img/up-head.jpg" class="update-logo-btn">
            <input type="file" accept="image/gif,image/jpeg,image/jpg,image/png" id="fileCrop">
            <div id="logoDate" class="hide"><a class="del-img" id="delLogo">删除</a></div>
        </div>
        <div class="section">
            <h1>技师封面<span>(最多上传3张)</span></h1>
            <ul id="bannersWrap">
                <li class="update-img">
                    <img src="img/up-load.jpg" class="file-add">
                    <a class="del-img delBanner">删除</a>
                </li>
                <li class="update-img">
                    <img src="img/up-load.jpg" class="file-add">
                    <a class="del-img delBanner">删除</a>
                </li>
                <li class="update-img">
                    <img src="img/up-load.jpg" class="file-add">
                    <a class="del-img delBanner">删除</a>
                </li>
                <div class="clear"></div>
            </ul>
        </div>
        <div class="section">
            <h1>可选项目</h1>
            <ul class="project-select">
                <li><label><input type="checkbox" id="allProject"> 全选</label></li>
                <div id="proje" class="clear"></div>
                <div class="clear"></div>
            </ul>
        </div>
        
        <button class="btn btn-show" id="submit">发布</button>
        <button class="btn btn-hide">发布中...</button>
    </div>
    <div class="clear"></div>
</div>
<div class="dialog bigger crop-wrap">
    <div class="title">编辑图片<a class="close">&times;</a></div>
    <div class="container">
        <div id="wrap"></div>
        <div style="margin-top: 10px;">
            <button class="btn btn-default btn-small close">取消</button>
            <button id="saveImg" class="btn btn-show btn-small">确定</button>
            <button class="btn btn-hide btn-small">上传中...</button>
        </div>
    </div>
</div>
<div class="main-footer">&copy; 2017强适信息科技（上海）有限公司</div>
<script type="text/javascript" src="./js/jQuery/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="./js/jQuery/jquery.cookie.js"></script>
<script type="text/javascript" src="./js/jquery.popup.js"></script>
<script type="text/javascript" src="./js/api.js"></script>
<script type="text/javascript">
var Common = {
    backLogin: function(){window.location.href = "login.html";},
    getImgData: function(img, dir, next) {
        let image = new Image();
        image.onload = function(){
            let degree = 0,drawWidth,drawHeight,width,height;
            drawWidth = this.naturalWidth;
            drawHeight = this.naturalHeight;
            if(drawWidth > 2000 || drawHeight > 2000){
                drawWidth = drawWidth / 3;
                drawHeight = drawHeight / 3;
            }
            let canvas = document.createElement('canvas');
            canvas.width = width = drawWidth;
            canvas.height = height = drawHeight; 
            let context = canvas.getContext('2d');
            let isRouter = true;
            //判断图片方向，重置canvas大小，确定旋转角度，iphone默认的是home键在右方的横屏拍摄方式
            switch(dir){
                //iphone横屏拍摄，此时home键在左侧
                case 3:
                    degree = 180;
                    drawWidth = -width;
                    drawHeight = -height;
                    break;
                //iphone竖屏拍摄，此时home键在下方(正常拿手机的方向)
                case 6:
                    canvas.width = height;
                    canvas.height = width; 
                    degree = 90;
                    drawWidth = width;
                    drawHeight = -height;
                    break;
                //iphone竖屏拍摄，此时home键在上方
                case 8:
                    canvas.width = height;
                    canvas.height = width; 
                    degree = 270;
                    drawWidth = -width;
                    drawHeight = height;
                    break;
            }
            //使用canvas旋转校正
            context.rotate(degree * Math.PI / 180);
            context.drawImage(this, 0 , 0, drawWidth, drawHeight);
            next(canvas.toDataURL(0.7));
        }
        image.src = img;
    },
    storeLabel: [ '环境优雅', '设备完善', '价格合理', '下次还来', '环境一般', '设施一般', '性价比低', '有待提高', '环境恶劣', '设施陈旧', '价格坑爹', '绝不再来'
    ],
    tecLabel: [ '服务热情', '手法专业', '态度很好', '颜值爆表', '服务一般', '手法一般', '态度一般', '看的过去', '服务太差', '手法太差', '态度恶劣', '惨不忍睹'
    ]
};
Array.prototype.remove = function(val) {
  var index = this.indexOf(val);
  if (index > -1) {
    this.splice(index, 1);
  }
};
Date.prototype.format = function(format) {
   var date = {
          "M+": this.getMonth() + 1,
          "d+": this.getDate(),
          "h+": this.getHours(),
          "m+": this.getMinutes(),
          "s+": this.getSeconds(),
          "q+": Math.floor((this.getMonth() + 3) / 3),
          "S+": this.getMilliseconds()
   };
   if (/(y+)/i.test(format)) {
          format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
   }
   for (var k in date) {
          if (new RegExp("(" + k + ")").test(format)) {
                 format = format.replace(RegExp.$1, RegExp.$1.length == 1
                        ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
          }
   }
   return format;
}
var showWebLogo = function(){
    if($.cookie('logo')){
        $('.logo').html('<img src="'+ $.cookie('logo') +'">');
    }
    if($.cookie('webName')){
        $('#shopTopName').text($.cookie('webName'));
    }
}
var getCookie = function(){
    $('.selectd span').html('');
    $('.order-menu').find('a').removeClass('active');
    if($.cookie('order_project')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_project') ).text +'</a>');
        $('.order-menu').find('a:eq(0)').addClass('active');
    }
    if($.cookie('order_tech')){
        $('.selectd span').append('<a>工号: '+ JSON.parse( $.cookie('order_tech') ).no + ' 昵称: ' + JSON.parse( $.cookie('order_tech') ).nick + '</a>');
        $('.order-menu').find('a:eq(1)').addClass('active');
    }
    if($.cookie('order_room')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_room') ).no +'</a>');
        $('.order-menu').find('a:eq(2)').addClass('active');
    }
};
$(function(){
    if (!!window.ActiveXObject || "ActiveXObject" in window)  {
        $('body').before('<div class="chrome">您的浏览器版本过低，部分功能无法使用，请下载chrome谷歌浏览器！<a href="http://rj.baidu.com/soft/detail/14744.html" target="_blank">去下载</a></div>')
    };
    showWebLogo();
    // 删除cookies
    $('.add-item').click(function(){ $.cookie( 'editID', null); });
    // 退出
    $('#exit').click(function(){
      if(confirm('确定退出吗？')){
        $.cookie( 'accessToken', null);
        Common.backLogin();
      }
    });
});
</script>
<script src="js/jQuery/laydate.js"></script>
<script type="text/javascript" src="js/jQuery/cropper.js"></script>
<script type="text/javascript" src="js/exif.js"></script>
<script type="text/javascript">
$(function(){
    $('.main').find('.menu:eq(1)').addClass('active');
    $('.c-left').find('dl:eq(1)').find('dd:eq(1)').addClass('active');

    // 获取省份
    var getProvincesFn = function(val){
        $.post(API.getProvinces, {
            token: $.cookie('accessToken'),
            type: 'province'
        }, function(data){
            for(var i=0; i<data.list.length; i++){
                if(val && val == data.list[i].value) $('#techNative').append('<option value="'+data.list[i].value+'" selected>'+data.list[i].text+'</option>');
                else $('#techNative').append('<option value="'+data.list[i].value+'">'+data.list[i].text+'</option>');
            }
        });
    } 
    // 获取可选项目
    var getAllProjectFn = function(arr){
        $.post(API.getAllProject, {
            token: $.cookie('accessToken')
        }, function(data){
            if(data.errorInfo){alert(data.errorInfo);Common.backLogin();return;}
            if(data.list.length <=0 ) return;
            for(var i=0; i<data.list.length; i++){
                var _data = data.list[i];
                if(_data.item_status == 1){
                    if(arr && arr.indexOf(_data.item_id) >= 0) $('#proje').after('<li><label><input type="checkbox" value="'+ _data.item_id +'" name="project" checked> '+_data.item_name+'</label></li>');
                    else $('#proje').after('<li><label><input type="checkbox" value="'+ _data.item_id +'" name="project"> '+_data.item_name+'</label></li>');
                }
            }
        });
    }
    // 获取是否修改
    if($.cookie('editID')){
        $('#varTitle').text('修改技师');
        $.post(API.getObejctInfo, {
            token: $.cookie('accessToken'),
            type: 'technician',
            pid: $.cookie('editID')
        }, function(data){
            if(data.errorInfo){history.go(-1);return;}
            $('#techNo').val(data.object.massagist_no);
            $('#techNick').val(data.object.massagist_name);
            $('#datetimepicker').val( new Date(data.object.massagist_birth*1000).format('yyyy-MM-dd') );

            logo = data.object.massagist_photo;
            showLogo(true);

            if(data.object.massagist_image && data.object.massagist_image.length > 0){
                banners = [];
                for(var i=0; i<data.object.massagist_image.length; i++){
                    banners.push(data.object.massagist_image[i].img_url);
                }
                showBanners();
            }

            $("input[name='sex']").eq(data.object.massagist_sex-1).attr("checked","checked");

            // 省份
            getProvincesFn(data.object.massagist_native);
            getAllProjectFn(data.object.massagist_p_id);
        });
    }else{
        getProvincesFn();
        getAllProjectFn();
    }
    // logo
    var logo = null;
    var banners = [];
    var activeType = 1; //1：上传logo; 2：上传banner
    // 显示logo
    var showLogo = function(type){
        if(type){
            $('.update-logo-btn').hide();
            $('#logoDate').show().css('backgroundImage', 'url('+HOST + logo+')');
            $('#logoDate .del-img').show();
            showWebLogo();
        }else{
            $('#logoDate').hide();
            logo = null;
            $('.update-logo-btn').show();
            showWebLogo();
        }
    }
    // 显示banner
    var showBanners = function(){
        for(var i=0; i<5; i++){
            if(banners[i]){
                $('#bannersWrap li:eq(' + i + ')').find('img').attr('src', HOST + banners[i]).removeClass('file-add');
                $('#bannersWrap li:eq(' + i + ')').find('a').show();
            }else{
                $('#bannersWrap li:eq(' + i + ')').find('img').attr('src', 'img/up-load.jpg').addClass('file-add');
                $('#bannersWrap li:eq(' + i + ')').find('a').hide();
            }
        }
    }    
    // 选择banner图片
    $(document).on('click', '.file-add', function(){
        activeType = 2;
        $('#fileCrop').click();
    });
    // 选择logo图片
    $('.update-logo-btn').click(function(){
        activeType = 1;
        $('#fileCrop').click();
    });
    // 选择图片
    $('#fileCrop').change(function(){
        $('#wrap').html('<img class="cropper">')
        var file = document.getElementById('fileCrop').files[0];
        $().popup({container: '.crop-wrap'});
        EXIF.getData(file, function(){
            var obj = Object.assign({}, EXIF.getAllTags(this))
            orientation = obj.Orientation
        });
        var reader = new FileReader();
        reader.onload = function(e) {
            Common.getImgData(e.target.result, orientation, function(data){
                var pic = new Image()
                pic.src = data
                pic.onload= function() {
                    $('.cropper').attr('src', data);
                    setTimeout(function(){
                        if(activeType == 1) $(".cropper").cropper({aspectRatio: 1 / 1});
                        if(activeType == 2) $(".cropper").cropper({aspectRatio: 1 / 0.466});
                    }, 100);
                }
            });
        };
        reader.readAsDataURL(file);
    });
    // 裁剪
    $('#saveImg').click(function(){
        $(this).hide().next('.btn-hide').show();
        var dataURL = $(".cropper").cropper("getDataURL");
        var picURL = dataURL.replace(/^.*?,/, '');
        $.post(API.uploadImage, {
            token: $.cookie('accessToken'),
            base64: picURL
        }, function(data){
            if(data.errorInfo){alert(data.errorInfo);return;}
            if(activeType == 1){
                logo = data.list;
                showLogo(true);
            }
            if(activeType == 2){
                banners.push(data.list);
                showBanners();
            }
            $('#saveImg').show();
            $('.btn-hide').hide();
            $().popup({container: '.crop-wrap', close: true});
        });
    });
    // 删除logo
    $('#delLogo').click(function(event) { showLogo(false); });
    // 删除banners
    $('.delBanner').click(function(event) {
        var self = $(this).prev('img');
        banners.remove( self.attr('src').split(HOST)[1] );
        showBanners();
    });
    // 全选
    $('#allProject').change(function(){
        if($(this).attr('checked')){
            $('.project-select').find('input').attr('checked', true);
        }else{
            $('.project-select').find('input').attr('checked', false);
        }
    });
    

    // 发布
    $('#submit').click(function(){
        if(banners.length <= 0 || !logo){
            alert('请上传图片');
            return;
        }
        var techNo = $.trim( $('#techNo').val() );
        var techNick = $.trim( $('#techNick').val() );
        var techNative = $.trim( $('#techNative').val() );
        var datetimepicker = $.trim( $('#datetimepicker').val() );
        var sex = $.trim($( 'input[name="sex"]:checked' ).val() );
        var p_id = [];
        $('input[name="project"]:checked').each(function(){ 
            p_id.push($(this).val()); 
        }); 
        if(!techNo || !techNick || !techNative || !datetimepicker || !sex){
            alert('内容不能为空');
            return;
        }
        $('#submit').hide().next('.btn-hide').show();
        var _data = {
            token: $.cookie('accessToken'),
            type: 'technician',
            name: techNick,
            no: techNo,
            photo: logo,
            native: techNative,
            sex: sex,
            birth: datetimepicker,
            cover: banners,
            p_id: p_id
        };
        if($.cookie('editID')) _data.id = $.cookie('editID');
        $.post(API.updateObjectInfo, _data, function(data){
            $('#submit').show().next('.btn-hide').hide();
            if(data.errorInfo){alert(data.errorInfo);return;}
            alert('发布成功');
            window.location.href = "tech-list.html";
        });
    });
})
</script>
</body>
</html>