<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta name="format-detection" content="telphone=no, email=no"/>
    <title>养生汇系统</title>
    <link rel="stylesheet" href="./css/base.css?v=0.0.6">
    <link rel="stylesheet" href="./css/function.css?v=0.0.6">
    <link rel="stylesheet" href="./css/style.css?v=0.0.6">
</head>
<body>
<div class="menu-container">
    <div class="main">
        <div class="logo">店铺LOGO</div>
        <div class="shop-info"><span id="shopTopName"></span> <a id="exit">退出</a></div>
        <a class="menu" href="vip.html"><img src="img/ico-vip.png"></a>
        <a class="menu" href="shop.html"><img src="img/ico-submit.png"></a>
        <a class="menu" href="order-list.html"><img src="img/ico-order.png"></a>
        <a class="menu" href="order-choose-project.html"><img src="img/ico-shop.png"></a>
        <a class="menu" href="rank-tech.html"><img src="img/ico-rank.png"></a>
    </div>
</div>
<div class="main-container order-container">
<div class="order-info-container">
    <div class="info-title-h1">订单详情</div>
    <div class="title">
        订单号：<span id="orderNo"></span>&nbsp;&nbsp;&nbsp;&nbsp;
        交易时间：<span id="orderDateTime"></span>&nbsp;&nbsp;&nbsp;&nbsp;
        付款时间：<span id="orderPayTime"></span>
    </div>
    <table id="h1Info" class="info-table width left">
        <tbody>
            <tr>
                <td id="cao"></td>
                <td id="val"></td>
            </tr>
        </tbody>
    </table>
    <!-- <div class="order-infos">
        订单状态：<span id="orderStatus"></span><br>
        订单金额：<span id="orderMoney" class="show-color"></span><br>
        交易时间：<span id="orderDateTime"></span><br>
        付款时间：<span id="orderPayTime"></span><br>
    </div> -->
    <div class="order-width">
    <div class="title">订单信息</div>
    <table class="info-table">
        <thead>
            <tr>
                <th>订单状态</th>
                <th>订单金额</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="show-color"><span id="orderStatus"></span></td>
                <td class="show-color"><span id="orderMoney"></span></td>
            </tr>
        </tbody>
    </table>
    </div>
    
    <div class="order-width">
    <div class="title">迎宾/手牌</div>
    <table class="info-table">
        <thead>
            <tr>
                <th width="50%">迎宾</th>
                <th>手牌</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="peopleInfo"></td>
                <td id="handInfo"></td>
            </tr>
        </tbody>
    </table>
    </div>

    <div class="order-width">
    <div class="title">房间信息</div>
    <table class="info-table">
        <thead>
            <tr>
                <th width="40%">消费类型</th>
                <th>房间号</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="show-color" id="addressType"></td>
                <td id="roomNo"></td>
            </tr>
        </tbody>
    </table>
    </div>

    <div class="order-width">
    <div class="title">技师信息</div>
    <table class="info-table left">
        <tbody>
            <tr>
                <td width="100" style="padding: 4px;"><img id="techHead" src="" class="haed"></td>
                <td class="tech-cookies" style="padding: 0;"></td>
            </tr>
        </tbody>
    </table>
    </div>
    <div class="clear"></div>

    <div class="title">项目信息</div>
    <table class="info-table width">
        <thead>
            <tr>
                <th colspan="2">项目名称</th>
                <th id="vipText"></th>
                <th>数量</th>
                <th>小计</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td width="100"><img id="proHead" src="" class="haed"></td>
                <td id="proName" style="text-align: left;"></td>
                <td class="vipValue"></td>
                <td>1</td>
                <td class="vipValue show-color"></td>
            </tr>
            <tr>
                <td colspan="5" style="text-align: left;">
                    <label><input type="radio" name="vip" value="0"> 非会员</label>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <label><input type="radio" name="vip" value="1"> 会员</label>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="title">商品消费 <a id="editGoods">管理</a></div>
    <table class="info-table width">
        <thead>
            <tr>
                <th>图片</th>
                <th>名称</th>
                <th>价格</th>
                <th>数量</th>
            </tr>
        </thead>
        <tbody id="cusGoods"></tbody>
        <tr id="goodsPrice">
            <td style="text-align: left;" colspan="4">总价：￥<span></span></td>
        </tr>
    </table>

    <div class="price-container">
        <div class="left-p">
            <a class="btn-add"><i class="iconfont">&#xe61f;</i> 添加其他变动金额</a>
            <ul class="changeMoney" style="display: none;">

                <li>优惠金额: <input id="preMoney" type="text" class="input-little">元&nbsp;&nbsp;&nbsp;&nbsp;备注: <input id="preText" type="text" class="input-small"><a class="btn btn-show btn-little" style="border-radius: 0px;" id="submitPre">确定</a></li>

                <li>增加金额: <input id="addMoney" type="text" class="input-little">元&nbsp;&nbsp;&nbsp;&nbsp;备注: <input id="addText" type="text" class="input-small"><a class="btn btn-show btn-little" style="border-radius: 0px;" id="submitAdd">确定</a></li>

            </ul>
        </div>
        <div class="right-p text-right no-status-pay">
            <h2>订单总价： <span class="vipValue"></span></h2>
            <h3>其他优惠： ¥<span class="preMoney">0</span></h3>
            <h3>其他增加金额： ¥<span class="addMoney">0</span></h3>
        </div>
        <div class="right-p text-right success-status-pay" style="display: none;">
            <h2>订单总价： ¥<span class="suc-item-pri"></span></h2>
            <h3>其他优惠： ¥<span class="suc-pre-pri"></span></h3>
            <h3>其他增加金额： ¥<span class="suc-add-pri"></span></h3>
        </div>
        <div class="clear"></div>
    </div>
    <div class="position-price">
        <div class="p no-status-pay">应付金额：<span id="payNub"></span></div>
        <div class="p success-status-pay" style="display: none;">实付金额：<span id="sucPay"></span></div>
    </div>
</div>
</div>

<div class="dialog big consume-container">
    <div class="title">选择商品<a class="close">&times;</a></div>
    <div class="container">
        <table class="table-default">
            <tbody class="tbody"></tbody>
            <tr>
                <td align="center" colspan="4">
                    <button class="btn btn-default btn-small close">取消</button>
                    <button class="btn btn-show btn-small" id="selectGood">确定</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="main-footer">沪ICP备16046454号-2 &copy; 2016-2017强适信息科技（上海）有限公司</div>
<script type="text/javascript" src="./js/jQuery/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="./js/jQuery/jquery.cookie.js"></script>
<script type="text/javascript" src="./js/jquery.popup.js"></script>
<script type="text/javascript" src="./js/api.js"></script>
<script type="text/javascript">
var Common = {
    backLogin: function(){window.location.href = "login.html";},
    getImgData: function(img, dir, next) {
        var image = new Image();
        image.onload = function(){
            var degree = 0,drawWidth,drawHeight,width,height;
            drawWidth = this.naturalWidth;
            drawHeight = this.naturalHeight;
            if(drawWidth > 2000 || drawHeight > 2000){
                drawWidth = drawWidth / 3;
                drawHeight = drawHeight / 3;
            }
            var canvas = document.createElement('canvas');
            canvas.width = width = drawWidth;
            canvas.height = height = drawHeight; 
            var context = canvas.getContext('2d');
            var isRouter = true;
            //判断图片方向，重置canvas大小，确定旋转角度，iphone默认的是home键在右方的横屏拍摄方式
            switch(dir){
                //iphone横屏拍摄，此时home键在左侧
                case 0:
                    canvas.width = height;
                    canvas.height = width; 
                    degree = 90;
                    drawWidth = width;
                    drawHeight = -height;
                    break;
                //iphone横屏拍摄，此时home键在左侧
                case 3:
                    degree = 180;
                    drawWidth = -width;
                    drawHeight = -height;
                    break;
                //iphone竖屏拍摄，此时home键在下方(正常拿手机的方向)
                case 6:
                    canvas.width = height;
                    canvas.height = width; 
                    degree = 90;
                    drawWidth = width;
                    drawHeight = -height;
                    break;
                //iphone竖屏拍摄，此时home键在上方
                case 8:
                    canvas.width = height;
                    canvas.height = width; 
                    degree = 270;
                    drawWidth = -width;
                    drawHeight = height;
                    break;
            }
            //使用canvas旋转校正
            context.rotate(degree * Math.PI / 180);
            context.drawImage(this, 0 , 0, drawWidth, drawHeight);
            next(canvas.toDataURL(0.7));
        }
        image.src = img;
    },
    storeLabel: [ '环境优雅', '设备完善', '价格合理', '下次还来', '环境一般', '设施一般', '性价比低', '有待提高', '环境恶劣', '设施陈旧', '价格坑爹', '绝不再来'
    ],
    tecLabel: [ '服务热情', '手法专业', '态度很好', '颜值爆表', '服务一般', '手法一般', '态度一般', '看的过去', '服务太差', '手法太差', '态度恶劣', '惨不忍睹'
    ]
};
Array.prototype.remove = function(val) {
  var index = this.indexOf(val);
  if (index > -1) {
    this.splice(index, 1);
  }
};
Date.prototype.format = function(format) {
   var date = {
          "M+": this.getMonth() + 1,
          "d+": this.getDate(),
          "h+": this.getHours(),
          "m+": this.getMinutes(),
          "s+": this.getSeconds(),
          "q+": Math.floor((this.getMonth() + 3) / 3),
          "S+": this.getMilliseconds()
   };
   if (/(y+)/i.test(format)) {
          format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
   }
   for (var k in date) {
          if (new RegExp("(" + k + ")").test(format)) {
                 format = format.replace(RegExp.$1, RegExp.$1.length == 1
                        ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
          }
   }
   return format;
}
var showWebLogo = function(){
    if($.cookie('logo')){
        $('.logo').html('<img src="'+ $.cookie('logo') +'">');
    }
    if($.cookie('webName')){
        $('#shopTopName').text($.cookie('webName'));
    }
}
var getCookie = function(){
    $('.selectd span').html('');
    $('.order-menu').find('a').removeClass('active');
    if($.cookie('order_people')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_people') ).text +'</a>');
        $('.order-menu').find('a:eq(0)').addClass('active');
    }
    if($.cookie('order_hand')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_hand') ).text +'</a>');
        $('.order-menu').find('a:eq(1)').addClass('active');
    }
    if($.cookie('order_project')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_project') ).text +'</a>');
        $('.order-menu').find('a:eq(2)').addClass('active');
    }
    if($.cookie('order_tech')){
        $('.selectd span').append('<a>工号: '+ JSON.parse( $.cookie('order_tech') ).no + ' 昵称: ' + JSON.parse( $.cookie('order_tech') ).nick + '</a>');
        $('.order-menu').find('a:eq(3)').addClass('active');
    }
    if($.cookie('order_room')){
        $('.selectd span').append('<a>'+ JSON.parse( $.cookie('order_room') ).no +'</a>');
        $('.order-menu').find('a:eq(4)').addClass('active');
    }
};
$(function(){
    if (!!window.ActiveXObject || "ActiveXObject" in window)  {
        $('body').before('<div class="chrome">您的浏览器版本过低，部分功能无法使用，请下载chrome谷歌浏览器！<a href="http://rj.baidu.com/soft/detail/14744.html" target="_blank">去下载</a></div>')
    };
    showWebLogo();
    // 删除cookies
    $('.add-item').click(function(){ $.cookie( 'editID', null); });
    // 退出
    $('#exit').click(function(){
      if(confirm('确定退出吗？')){
        $.cookie( 'accessToken', null);
        Common.backLogin();
      }
    });
    // 
    $('input').focus(function(){
        $(this).css('border-color', '#f6bd73');
    });
    $('input').blur(function(){
        $(this).css('border-color', '#ddd');
    });
});
    
</script>
<script type="text/javascript">
$(function(){
    $('.main').find('.menu:eq(2)').addClass('active');
    var id = $.cookie('order_info_id');
    var type = 0;
    var goodsInfoId = [];
    var changePrice = {
        prePrice: 0,
        addPrice: 0,
        preText: '',
        addText: ''
    };
    $('#peopleInfo').on('click', '#btnEditPeople', function(event) {
        var _html = $('#peopleInfo').html();
        var _id = $(this).attr('data-id');
        $.post(API.getUsherList, {
            token: $.cookie('accessToken')
        }, function(data){
            if(data.errorInfo){alert(data.errorInfo);Common.backLogin();return;}
            if(!data.object || data.object.length <=0 ){
                alert('还没有添加迎宾')
                return;
            }
            var option = '';
            for(var i=0; i<data.object.length; i++){
                var _data = data.object[i];
                if(_id == _data.staff_id){
                    option+= '<option value="'+_data.staff_id+'" selected>'+_data.staff_name+'</option>';
                }else{
                    option+= '<option value="'+_data.staff_id+'">'+_data.staff_name+'</option>';
                }
            }
            $('#peopleInfo').html('<select id="newPeople">'+option+'</select><br><br><a class="btn-ok">确定</a><a class="btn-can">取消</a>');
            $('.btn-can').click(function(){ $('#peopleInfo').html(_html); });
            $('.btn-ok').click(function(){ 
                $.post(API.add_usher_order, {
                    token: $.cookie('accessToken'),
                    id: id,
                    sid: $('#newPeople').val(),
                }, function(data){
                    if(data.errorInfo){alert(data.errorInfo);return;}
                    location.reload();
                });
            });
        });
    });
    $('#editGoods').click(function(event) {
        $().popup({loading: 'true'});
        $.post(API.getThisOrderGoods, {
            token: $.cookie('accessToken'),
            pid: id
        }, function(data){
            var goodList = data.list ? data.list : [];
            $.post(API.addGoodsList, {
                token: $.cookie('accessToken'),
                state: 1
            }, function(data){
                if(data.errorInfo){alert(data.errorInfo);return;}
                $().popup({container: '.consume-container'});
                $().popup({loading: 'false'});
                $('.consume-container .tbody').html('');
                for(var i=0; i<data.list.length; i++){
                    var _data = data.list[i];
                    // 数量
                    var numHtml = '<input type="text" value="0">';
                    for(var j=0; j<goodList.length; j++){
                        if(goodList[j].id == _data.goods_id){
                            numHtml = '<input type="text" value="'+goodList[j].num+'">';
                        }
                    }
                    $('.consume-container .tbody').append('\
                        <tr data-id="'+_data.goods_id+'">\
                            <td width="50"><img src="'+HOST+_data.goods_head+'" alt="" class="head"></td>\
                            <td>'+_data.goods_name+'</td>\
                            <td width="80" class="center">￥'+_data.goods_price+'</td>\
                            <td width="100" class="center"><div class="number-compass"><a class="left">-</a>'+ numHtml +'<a class="right">+</a></div></td>\
                        </tr>');
                }
            });
        });
    });
    $('.consume-container .tbody').on('click', '.left', function(){
        var _v = parseInt($(this).next().val());
        if(_v==0) return;
        $(this).next().val(_v - 1);
        setGoodId();
    });
    $('.consume-container .tbody').on('click', '.right', function(){
        var _v = parseInt($(this).prev().val());
        $(this).prev().val(_v + 1);
        setGoodId();
    });
    var setGoodId = function(){
        goodsInfoId = [];
        for(var i=0; i<$('.consume-container .tbody tr').length; i++){
            for(var j=0; j<$('.consume-container .tbody tr:eq('+i+')').find('input').val(); j++){
                goodsInfoId.push($('.consume-container .tbody tr:eq('+i+')').attr('data-id'));
            }
        }
    }
    $('#selectGood').click(function(){
        if(goodsInfoId.length == 0){
            alert('请添加或修改商品');
            return;
        }
        $.post(API.addGoodsThisOrder, {
            token: $.cookie('accessToken'),
            id: id,
            goods: goodsInfoId,
        }, function(data){
            if(data.errorInfo){alert(data.errorInfo);return;}
            alert('添加成功');
            window.location.reload();
        });
    })
        
    var getOrderInfo = function(){
        $().popup({loading: 'true'});
        $.post(API.getThisOrderInfo, {
            token: $.cookie('accessToken'),
            id: id
        }, function(data){
            $().popup({loading: 'false'});
            if(data.errorInfo){alert(data.errorInfo);Common.backLogin();return;}
            var order = data.list;
            $('body').attr('data-id', order.order_id);
            $('#orderNo').text(order.order_num);

            if(order.room_num){
                $('#addressType').text('在店消费');
                $('#roomNo').text(order.room_num);
            }else if(order.order_room_num){
                $('#addressType').text('技师上门');
                $('#roomNo').text(order.order_room_num);
            }
            $('#techHead').attr('src', HOST + order.massagist_photo);
            $('.tech-cookies').html('工号：' + order.massagist_no + '<br><br>昵称：' + order.massagist_name);
            order.staff_name ? $('#peopleInfo').text( order.staff_name ) : $('#peopleInfo').text('暂无');
            $('#peopleInfo').append('<a id="btnEditPeople" data-id="'+order.order_staff_id+'" class="btn-p-e">添加/修改</a>')
            order.hand_name ? $('#handInfo').text( order.hand_name ) : $('#handInfo').text('暂无');
            // 状态
            var statusBtn = '';
            var statusText = '';
            var cao = '';
            if(order.order_status == 1){
                $('#h1Info').hide();
                if(order.order_pay == 0){
                    statusText = '<span class="status active">待支付</span>';
                    cao = '<a class="submit">确认付款</a>';
                }else{
                    statusText = '<span class="status do">已完成</span>';
                    $('.btn-add').hide();
                    // 
                    $('.no-status-pay').hide();
                    $('.success-status-pay').show();
                    $('#sucPay').text('¥' + order.order_totalprice);
                    var _preTx = '';
                    var _addTx = '';
                    order.order_reduce ? _preTx = '，' + order.order_reduce : _preTx = '';
                    order.order_increase ? _addTx = '，' + order.order_increase : _addTx = '';
                    $('.suc-pre-pri').text(order.order_discount_price + _preTx);
                    $('.suc-add-pri').text(order.order_add_price + _addTx);
                    $('.suc-item-pri').text(order.order_totalprice - order.order_add_price + parseFloat(order.order_discount_price));
                }
            }
            if(order.order_status == 2){
                $('#h1Info').hide();
                $('.left-p').hide();
                statusText = '<span class="status cancel">已取消</span>';
                cao = '<a class="btn-prev del">删除订单</a>';
            }
            if(order.order_status == 3){
                $('.left-p').hide();
                statusBtn = '<a class="btn btn-default btn-little up-work">上钟</a>';
                statusText = '<span class="status wait">等待上钟</span>';
                cao = '<a class="btn-prev cancel">取消订单</a>';
            }
            if(order.order_status == 4){
                $('.left-p').hide();
                statusBtn = '<a class="btn btn-default btn-little down-work">下钟</a>';
                statusText = '<span class="status active">上钟</span>';
                if(order.order_addtime == 1){
                    statusBtn+= '<a class="btn btn-default btn-little add-work">加钟</a>';
                    var miao = order.order_item_starttime - Date.parse(new Date())/1000;
                    showTime(miao, 1);
                }
                if(order.order_addtime == 2){
                    showTime(order.order_item_starttime, 2);
                }
            }
            if(order.order_status == 5){
                $('#h1Info').hide();
                $('.left-p').hide();
                statusText = '<span class="status cancel">已删除</span>';
            }
            if(order.order_status == 6){
                $('#h1Info').hide();
                statusText = '<span class="status active">待确认</span>';
                cao = '<a class="submit" data-type="1">确认金额后付款</a>';
            }
            $('.position-price').append(cao);
            $('#cao').html(statusBtn);
            $('#orderStatus').html(statusText);
            $('#orderMoney').html(order.order_totalprice + '元');
            $('#orderDateTime').html(new Date(order.order_createtime*1000).format('yyyy-MM-dd hh:mm:ss'));
            order.order_donetime ? $('#orderPayTime').html(new Date(order.order_donetime*1000).format('yyyy-MM-dd hh:mm:ss')) : $('#orderPayTime').html('待付款');

            $('#proHead').attr('src', HOST+order.item_image);
            $('#proName').text(order.item_name);
            if(type == 0){
                $('#vipText').text('非会员价');
                $('.vipValue').text('￥'+order.item_price);
                $('input[name="vip"]:eq(0)').attr('checked', true);
            }else{
                $('#vipText').text('会员价');
                $('.vipValue').text('￥'+order.item_vipprice);
                $('input[name="vip"]:eq(1)').attr('checked', true);
            }
            $('#payNub').text('￥'+order.order_totalprice );
            // $('#payNub').text('￥'+($('.vipValue').text().split('￥')[1]-changePrice.prePrice) );
            var _ =(parseFloat($('#payNub').text().split('￥')[1])+parseFloat(changePrice.addPrice));
            $('#payNub').text('￥'+ _);
        });
    }
    getOrderInfo();

    // 获取商品消费信心
    $.post(API.getThisOrderGoods, {
        token: $.cookie('accessToken'),
        pid: id
    }, function(data){
        $('#cusGoods').html('');
        var goodList = data.list ? data.list : [];
        if(goodList.length == 0){
            $('#cusGoods').html('<tr><td colspan="4">暂无</td></tr>');
            $('#goodsPrice').hide();
        }else{
            $('#goodsPrice span').text(data.object);
        }
        for(var i=0; i<goodList.length; i++){
            var _data = goodList[i];
            $('#cusGoods').append('\
                <tr>\
                    <td width="80"><img src="'+HOST+_data.image+'" width="80" class="head"></td>\
                    <td>'+_data.name+'</td>\
                    <td class="center">￥'+_data.price+'</td>\
                    <td class="center">'+_data.num+'</td>\
                </tr>');
        }
    });
    // 价格变动
    $('#submitPre').click(function(){
        changePrice.prePrice = parseFloat( $('#preMoney').val() ).toFixed(1);
        changePrice.preText = $.trim( $('#preText').val() );
        if( changePrice.prePrice && changePrice.prePrice != 'NaN' ){
            $('#preMoney').val(changePrice.prePrice);
            $('#preText').val(changePrice.preText);
            $('.preMoney').text(changePrice.prePrice);
            getOrderInfo();
        }else alert('输入格式错误');
    });
    $('#submitAdd').click(function(){
        changePrice.addPrice = parseFloat( $('#addMoney').val() ).toFixed(1);
        changePrice.addText = $.trim( $('#addText').val() );
        if( changePrice.addPrice && changePrice.addPrice != 'NaN' ){
            $('#addMoney').val(changePrice.addPrice);
            $('#addText').val(changePrice.addText);
            $('.addMoney').text(changePrice.addPrice);
            getOrderInfo();
        }else alert('输入格式错误');
    });
    // 会员价切换
    $('input[name="vip"]').change(function() {
        type = $(this).val();
        getOrderInfo();
    });
    $('.btn-add').click(function() {
        $(this).next().toggle(200);
    });
    // 上钟操作
     $('#cao').on('click', 'a.up-work, a.down-work, a.add-work', function(){
        var action = '';
        if( $(this).attr('class').indexOf('up-work')>=0 ) action = 'start';
        if( $(this).attr('class').indexOf('down-work')>=0 ) action = 'end';
        if( $(this).attr('class').indexOf('add-work')>=0 ) action = 'add';
        if(confirm('确定操作吗？')){
            var id = $(this).parent().parent().attr('data-id');
            $.post(API.pcUpdateOrderStae, {
                token: $.cookie('accessToken'),
                id: $('body').attr('data-id'),
                action: action
            }, function(data){
                if(data.errorInfo){alert(data.errorInfo);return;}
                location.reload();
            });
        }
    });
    var showTime = function(val, add){
        var h = Math.floor(val / 60 / 60);
        var m = Math.floor((val - h * 60 * 60) / 60);
        var s = Math.floor((val - h * 60 * 60 - m * 60));
        var jishi = h + ':' + m + ':' + s;
        $('#val').text(jishi);
        if(add == 1) val--;
        else if(add == 2) val++;
        if (val < 0){
            jishi = '00:00:00';
            $('#val').text(jishi);
        }else{
            setTimeout(function(){ showTime(val, add); }, 1000);
        }
    }
    // 取消
    $('.position-price').on('click', '.cancel', function(){
        if(confirm('确认取消吗？')){
            $.post(API.updateOrderStatus, {
                token: $.cookie('accessToken'),
                id: $('body').attr('data-id'),
                action: 'cancel',
            }, function(data){
                if(data.errorInfo){alert(data.errorInfo);return;}
                location.reload();
            });
        }
    });
    // 删除
    $('.position-price').on('click', '.del', function(){
        if(confirm('确认删除吗？')){
            $.post(API.updateOrderStatus, {
                token: $.cookie('accessToken'),
                id: $('body').attr('data-id'),
                action: 'delete',
            }, function(data){
                if(data.errorInfo){alert(data.errorInfo);return;}
                window.location.href = "order-list.html";
            });
        }
    });
    // 付款
    $('.position-price').on('click', '.submit', function(){
        if(confirm('确认付款吗？')){
            if($(this).attr('data-type')){
                if(!changePrice.addPrice || !changePrice.prePrice){
                    alert('请先确认金额，点击添加其他变动金额！');
                    return;
                }
                $.post(API.ConfirmPayment, {
                    token: $.cookie('accessToken'),
                    id: $('body').attr('data-id'),
                    action: 'update',
                    totalprice: parseFloat($('#payNub').text().split('￥')[1]),
                    reduce: changePrice.preText,
                    increase: changePrice.addText,
                    add_price: changePrice.addPrice,
                    discount_price: changePrice.prePrice
                }, function(data){
                    if(data.errorInfo){alert(data.errorInfo);return;}
                    $.post(API.ConfirmPayment, {
                        token: $.cookie('accessToken'),
                        id: $('body').attr('data-id'),
                        action: 'confirm',
                        totalprice: parseFloat($('#payNub').text().split('￥')[1]),
                        reduce: changePrice.preText,
                        increase: changePrice.addText,
                        add_price: changePrice.addPrice,
                        discount_price: changePrice.prePrice
                    }, function(data){
                        if(data.errorInfo){alert(data.errorInfo);return;}
                        location.reload();
                    });
                });

            }else{
                $.post(API.ConfirmPayment, {
                    token: $.cookie('accessToken'),
                    id: $('body').attr('data-id'),
                    action: 'confirm',
                    totalprice: parseFloat($('#payNub').text().split('￥')[1]),
                    reduce: changePrice.preText,
                    increase: changePrice.addText,
                    add_price: changePrice.addPrice,
                    discount_price: changePrice.prePrice
                }, function(data){
                    if(data.errorInfo){alert(data.errorInfo);return;}
                    location.reload();
                });
            }
        }
    })
})
</script>
</body>
</html>